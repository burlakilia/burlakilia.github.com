<?php 
header('Content-type: text/html; charset=utf-8'); 
?>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">

        <title>Генеральный план поселка 2</title>
        <script type="text/javascript" src="js/jquery.js"></script>
        <script type="text/javascript" src="js/imageMap.js"></script>
        <script type="text/javascript" src="js/layer_style.js"></script>
        <script type="text/javascript" src="data/status.js"></script>
        <script type="text/javascript" src="js/info.js"></script>

        <script type="text/javascript" src="js/openlayers.js"></script>
        <link href="style.css" rel="stylesheet"/>
        <script type="text/javascript">
            var imageMap,
                mouse = {},
                $form,
                saved = 0,
                timer;

            var countImages = 4, // максимальное количество картинок для участка
                formSelect = false, // признак того что пользователь выбрал сущность через форму
                imagePath = "/genplan/data/"; // url путь к хранилищу картинок

            var options = {
                imgUrl: "img/plan.jpg",
                imgWidth: 1600,
                imgHeight: 800,
                isAdmin: true,
                jsonUrl: 'data/houses.json',
                onSelect: show,
                onUnselect: hide
            };

            $(document).ready(function() {
                // настраиваем высоту окна
                $("#map").css("height", $(window).height() + "px");
                $form = $(document).find('#admin_poup');
                imageMap = $("#map").imageMap(options).addFeatures();
                options.isAdmin && $form.on('submit', onsubmit);
            });


            $(document).mousemove(function(e){
                if (!formSelect) {
                    mouse.x = e.pageX;
                    mouse.y = e.pageY;

                    $("#info").css("left",mouse.x - 10  + "px");
                    $("#info").css("top",mouse.y + 20 + "px");
                }
            });


           function onsubmit(e) {
                e.preventDefault();

                $.ajax({
                    type: 'post',
                    url: '/features/',
                    data: $form.serialize(),

                    success: function () {
                        $form.hide();
                        $form.find('input, select').val('');
                    }

                });

            }

            $(document).dblclick(function () {
                var coords = imageMap.getPolygon(imageMap.newPlacesLayer.features.length);

                if (!options.isAdmin) {
                    return;
                }

                $form.show();
                $form.find('[name="polygon"]').val(JSON.stringify(coords));
                $form.find('[name="id"]').val(imageMap.newPlacesLayer.features.length);
                $form.find('[name="number"]').focus();
            });

            $(window).resize(function() {
                $("#map").css("height", $(window).height() + "px");
            });

        </script>
    </head>

    <body style="margin: 0px;">
        <form id="admin_poup" style="display: none;">
            <input type="hidden" name="polygon"/>
            <input type="hidden" name="id"/>
            <label>номер <input type="text" name="number"/></label>
            <label>площадь <input type="text" name="sq"/></label>
            <label>статус
                <select type="text" name="status">
                    <option value="new">новый</option>
                    <option value="sold">проданный</option>
                    <option value="wait">ожидание</option>
                </select>
            </label>
            <label>тип
                <select type="text" name="type">
                    <option value="1">премиум</option>
                    <option value="2">бизнес</option>
                    <option value="3">стандарт</option>
                    <option value="4">эконом</option>
                    <option value="5">дисконт</option>
                </select>
            </label>
            <button type="submit">Сохранить</button>
        </form>
        <div id="preloader"><div id="preloaderProgress">Загрузка...</div></div>
        <div id="map" style="position:absolute; width:100%; height: 1000px; border: none;"></div>
        <div id="info" style="display: none; opacity: 0.9; font-size: 0.9em;">
            <div class="header"></div>
            <div class="content" style="vertical-align: top;">
                <div class='holderNumber' style="font-weight: bold;">№<span class='number'></span></div>
                <div class='holderText' style="font-weight: bold;"></div>
                <div class='holderDesc'></div>
                <div class='holderStatus'>Статус:<span class="status"></span></div>
                <div class='holderSq'>Площадь:<span class="sq"></span></div>
                <div class='holderPrice'>Цена:<span class="price"></span></div>
                <div class="images"></div>
            </div>
            <div class="footer"></div>
        </div>
    </body>
</html>
